import React, { useState, useEffect } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import apiService from '../services/apiService';
import './RemarkDetailPage.css';

function RemarkDetailPage() {
  const { id } = useParams();
  const navigate = useNavigate();
  const [remark, setRemark] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState('');

  useEffect(() => {
    loadRemark();
  }, [id]);

  const loadRemark = async () => {
    try {
      console.log('ğŸ“‹ Chargement remarque:', id);
      const data = await apiService.getRemarkById(id);
      console.log('âœ… Remarque chargÃ©e:', data);
      setRemark(data);
      setError('');
    } catch (err) {
      console.error('âŒ Erreur chargement remarque:', err);
      setError('Remarque non trouvÃ©e');
    } finally {
      setLoading(false);
    }
  };

  const getStatusColor = (status) => {
    const colors = {
      'En attente': '#f59e0b',
      'En cours': '#3b82f6',
      'TerminÃ©e': '#10b981',
      'RejetÃ©e': '#ef4444'
    };
    return colors[status] || '#64748b';
  };

  if (loading) {
    return (
      <div className="detail-page">
        <div className="loading-container">
          <div className="spinner"></div>
          <p>Chargement...</p>
        </div>
      </div>
    );
  }

  if (error || !remark) {
    return (
      <div className="detail-page">
        <header className="detail-header">
          <button onClick={() => navigate('/')} className="btn-back">
            â† Retour
          </button>
          <h1>Remarque</h1>
          <div style={{width: '70px'}}></div>
        </header>
        <div className="error-container">
          <div className="error-icon">âš ï¸</div>
          <h2>{error}</h2>
          <p>Cette remarque n'existe pas ou a Ã©tÃ© supprimÃ©e.</p>
          <button onClick={() => navigate('/')} className="btn-primary">
            Retour Ã  l'accueil
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className="detail-page">
      <header className="detail-header">
        <button onClick={() => navigate('/')} className="btn-back">
          â† Retour
        </button>
        <h1>DÃ©tails</h1>
        <div style={{width: '70px'}}></div>
      </header>

      <div className="detail-container">
        {/* Status Badge */}
        <div className="status-banner" style={{ background: getStatusColor(remark.status) + '15', borderLeft: `4px solid ${getStatusColor(remark.status)}` }}>
          <div className="status-icon" style={{ background: getStatusColor(remark.status) }}>
            {remark.status === 'En attente' && 'â³'}
            {remark.status === 'En cours' && 'ğŸ”§'}
            {remark.status === 'TerminÃ©e' && 'âœ…'}
            {remark.status === 'RejetÃ©e' && 'âŒ'}
          </div>
          <div>
            <div className="status-label">Statut</div>
            <div className="status-value" style={{ color: getStatusColor(remark.status) }}>
              {remark.status}
            </div>
          </div>
        </div>

        {/* Info Card */}
        <div className="info-card">
          <h2 className="card-title">ğŸ“‹ Informations</h2>
          
          <div className="info-row">
            <span className="info-label">CatÃ©gorie</span>
            <span className="info-value">{remark.category}</span>
          </div>

          <div className="info-row">
            <span className="info-label">Titre</span>
            <span className="info-value">{remark.title}</span>
          </div>

          {remark.description && (
            <div className="info-row">
              <span className="info-label">Description</span>
              <span className="info-value">{remark.description}</span>
            </div>
          )}

          <div className="info-row">
            <span className="info-label">Date de crÃ©ation</span>
            <span className="info-value">
              {new Date(remark.createdAt).toLocaleDateString('fr-FR', {
                day: '2-digit',
                month: 'long',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
              })}
            </span>
          </div>
        </div>

        {/* Photo */}
        {remark.photoUrl && (
          <div className="info-card">
            <h2 className="card-title">ğŸ“¸ Photo</h2>
            <div className="photo-container">
              <img 
                src={`https://saint-remeze-backend.onrender.com${remark.photoUrl}`}
                alt="Photo de la remarque"
                className="remark-photo"
                onError={(e) => {
                  e.target.style.display = 'none';
                  e.target.parentElement.innerHTML = '<p style="color: #64748b; text-align: center;">Photo non disponible</p>';
                }}
              />
            </div>
          </div>
        )}

        {/* Localisation */}
        {remark.location && remark.location.coordinates && (
          <div className="info-card">
            <h2 className="card-title">ğŸ“ Localisation</h2>
            <div className="location-info">
              <div className="location-coords">
                <span>Latitude: {remark.location.coordinates[1].toFixed(6)}</span>
                <span>Longitude: {remark.location.coordinates[0].toFixed(6)}</span>
              </div>
              <a
                href={`https://www.google.com/maps?q=${remark.location.coordinates[1]},${remark.location.coordinates[0]}`}
                target="_blank"
                rel="noopener noreferrer"
                className="btn-map"
              >
                ğŸ—ºï¸ Voir sur la carte
              </a>
            </div>
          </div>
        )}

        {/* Notes admin (si prÃ©sentes) */}
        {remark.adminNotes && (
          <div className="info-card">
            <h2 className="card-title">ğŸ’¬ Notes de l'administration</h2>
            <p className="admin-notes">{remark.adminNotes}</p>
          </div>
        )}

        {remark.assignedTo && (
          <div className="info-card">
            <h2 className="card-title">ğŸ‘¤ AssignÃ© Ã </h2>
            <p className="assigned-to">{remark.assignedTo}</p>
          </div>
        )}
      </div>
    </div>
  );
}

export default RemarkDetailPage;
